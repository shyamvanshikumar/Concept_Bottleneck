from PIL import Image
import torch
import torch.nn as nn
from torchvision import transforms
from infer.arch import MLP, initialize_pretrained_model

classifier_model = MLP(312,0, 200)
con_model = torch.load('model/indep_concept_model.pth', map_location=torch.device('cpu'))
classifier_model.load_state_dict(torch.load('model/indep_classifier_model_state_dict.pth', map_location=torch.device('cpu')))

concepts_keys = ['has_bill_shape::curved_(up_or_down)',
 'has_bill_shape::dagger',
 'has_bill_shape::hooked',
 'has_bill_shape::needle',
 'has_bill_shape::hooked_seabird',
 'has_bill_shape::spatulate',
 'has_bill_shape::all-purpose',
 'has_bill_shape::cone',
 'has_bill_shape::specialized',
 'has_wing_color::blue',
 'has_wing_color::brown',
 'has_wing_color::iridescent',
 'has_wing_color::purple',
 'has_wing_color::rufous',
 'has_wing_color::grey',
 'has_wing_color::yellow',
 'has_wing_color::olive',
 'has_wing_color::green',
 'has_wing_color::pink',
 'has_wing_color::orange',
 'has_wing_color::black',
 'has_wing_color::white',
 'has_wing_color::red',
 'has_wing_color::buff',
 'has_upperparts_color::blue',
 'has_upperparts_color::brown',
 'has_upperparts_color::iridescent',
 'has_upperparts_color::purple',
 'has_upperparts_color::rufous',
 'has_upperparts_color::grey',
 'has_upperparts_color::yellow',
 'has_upperparts_color::olive',
 'has_upperparts_color::green',
 'has_upperparts_color::pink',
 'has_upperparts_color::orange',
 'has_upperparts_color::black',
 'has_upperparts_color::white',
 'has_upperparts_color::red',
 'has_upperparts_color::buff',
 'has_underparts_color::blue',
 'has_underparts_color::brown',
 'has_underparts_color::iridescent',
 'has_underparts_color::purple',
 'has_underparts_color::rufous',
 'has_underparts_color::grey',
 'has_underparts_color::yellow',
 'has_underparts_color::olive',
 'has_underparts_color::green',
 'has_underparts_color::pink',
 'has_underparts_color::orange',
 'has_underparts_color::black',
 'has_underparts_color::white',
 'has_underparts_color::red',
 'has_underparts_color::buff',
 'has_breast_pattern::solid',
 'has_breast_pattern::spotted',
 'has_breast_pattern::striped',
 'has_breast_pattern::multi-colored',
 'has_back_color::blue',
 'has_back_color::brown',
 'has_back_color::iridescent',
 'has_back_color::purple',
 'has_back_color::rufous',
 'has_back_color::grey',
 'has_back_color::yellow',
 'has_back_color::olive',
 'has_back_color::green',
 'has_back_color::pink',
 'has_back_color::orange',
 'has_back_color::black',
 'has_back_color::white',
 'has_back_color::red',
 'has_back_color::buff',
 'has_tail_shape::forked_tail',
 'has_tail_shape::rounded_tail',
 'has_tail_shape::notched_tail',
 'has_tail_shape::fan-shaped_tail',
 'has_tail_shape::pointed_tail',
 'has_tail_shape::squared_tail',
 'has_upper_tail_color::blue',
 'has_upper_tail_color::brown',
 'has_upper_tail_color::iridescent',
 'has_upper_tail_color::purple',
 'has_upper_tail_color::rufous',
 'has_upper_tail_color::grey',
 'has_upper_tail_color::yellow',
 'has_upper_tail_color::olive',
 'has_upper_tail_color::green',
 'has_upper_tail_color::pink',
 'has_upper_tail_color::orange',
 'has_upper_tail_color::black',
 'has_upper_tail_color::white',
 'has_upper_tail_color::red',
 'has_upper_tail_color::buff',
 'has_head_pattern::spotted',
 'has_head_pattern::malar',
 'has_head_pattern::crested',
 'has_head_pattern::masked',
 'has_head_pattern::unique_pattern',
 'has_head_pattern::eyebrow',
 'has_head_pattern::eyering',
 'has_head_pattern::plain',
 'has_head_pattern::eyeline',
 'has_head_pattern::striped',
 'has_head_pattern::capped',
 'has_breast_color::blue',
 'has_breast_color::brown',
 'has_breast_color::iridescent',
 'has_breast_color::purple',
 'has_breast_color::rufous',
 'has_breast_color::grey',
 'has_breast_color::yellow',
 'has_breast_color::olive',
 'has_breast_color::green',
 'has_breast_color::pink',
 'has_breast_color::orange',
 'has_breast_color::black',
 'has_breast_color::white',
 'has_breast_color::red',
 'has_breast_color::buff',
 'has_throat_color::blue',
 'has_throat_color::brown',
 'has_throat_color::iridescent',
 'has_throat_color::purple',
 'has_throat_color::rufous',
 'has_throat_color::grey',
 'has_throat_color::yellow',
 'has_throat_color::olive',
 'has_throat_color::green',
 'has_throat_color::pink',
 'has_throat_color::orange',
 'has_throat_color::black',
 'has_throat_color::white',
 'has_throat_color::red',
 'has_throat_color::buff',
 'has_eye_color::blue',
 'has_eye_color::brown',
 'has_eye_color::purple',
 'has_eye_color::rufous',
 'has_eye_color::grey',
 'has_eye_color::yellow',
 'has_eye_color::olive',
 'has_eye_color::green',
 'has_eye_color::pink',
 'has_eye_color::orange',
 'has_eye_color::black',
 'has_eye_color::white',
 'has_eye_color::red',
 'has_eye_color::buff',
 'has_bill_length::about_the_same_as_head',
 'has_bill_length::longer_than_head',
 'has_bill_length::shorter_than_head',
 'has_forehead_color::blue',
 'has_forehead_color::brown',
 'has_forehead_color::iridescent',
 'has_forehead_color::purple',
 'has_forehead_color::rufous',
 'has_forehead_color::grey',
 'has_forehead_color::yellow',
 'has_forehead_color::olive',
 'has_forehead_color::green',
 'has_forehead_color::pink',
 'has_forehead_color::orange',
 'has_forehead_color::black',
 'has_forehead_color::white',
 'has_forehead_color::red',
 'has_forehead_color::buff',
 'has_under_tail_color::blue',
 'has_under_tail_color::brown',
 'has_under_tail_color::iridescent',
 'has_under_tail_color::purple',
 'has_under_tail_color::rufous',
 'has_under_tail_color::grey',
 'has_under_tail_color::yellow',
 'has_under_tail_color::olive',
 'has_under_tail_color::green',
 'has_under_tail_color::pink',
 'has_under_tail_color::orange',
 'has_under_tail_color::black',
 'has_under_tail_color::white',
 'has_under_tail_color::red',
 'has_under_tail_color::buff',
 'has_nape_color::blue',
 'has_nape_color::brown',
 'has_nape_color::iridescent',
 'has_nape_color::purple',
 'has_nape_color::rufous',
 'has_nape_color::grey',
 'has_nape_color::yellow',
 'has_nape_color::olive',
 'has_nape_color::green',
 'has_nape_color::pink',
 'has_nape_color::orange',
 'has_nape_color::black',
 'has_nape_color::white',
 'has_nape_color::red',
 'has_nape_color::buff',
 'has_belly_color::blue',
 'has_belly_color::brown',
 'has_belly_color::iridescent',
 'has_belly_color::purple',
 'has_belly_color::rufous',
 'has_belly_color::grey',
 'has_belly_color::yellow',
 'has_belly_color::olive',
 'has_belly_color::green',
 'has_belly_color::pink',
 'has_belly_color::orange',
 'has_belly_color::black',
 'has_belly_color::white',
 'has_belly_color::red',
 'has_belly_color::buff',
 'has_wing_shape::rounded-wings',
 'has_wing_shape::pointed-wings',
 'has_wing_shape::broad-wings',
 'has_wing_shape::tapered-wings',
 'has_wing_shape::long-wings',
 'has_size::large_(16_-_32_in)',
 'has_size::small_(5_-_9_in)',
 'has_size::very_large_(32_-_72_in)',
 'has_size::medium_(9_-_16_in)',
 'has_size::very_small_(3_-_5_in)',
 'has_shape::upright-perching_water-like',
 'has_shape::chicken-like-marsh',
 'has_shape::long-legged-like',
 'has_shape::duck-like',
 'has_shape::owl-like',
 'has_shape::gull-like',
 'has_shape::hummingbird-like',
 'has_shape::pigeon-like',
 'has_shape::tree-clinging-like',
 'has_shape::hawk-like',
 'has_shape::sandpiper-like',
 'has_shape::upland-ground-like',
 'has_shape::swallow-like',
 'has_shape::perching-like',
 'has_back_pattern::solid',
 'has_back_pattern::spotted',
 'has_back_pattern::striped',
 'has_back_pattern::multi-colored',
 'has_tail_pattern::solid',
 'has_tail_pattern::spotted',
 'has_tail_pattern::striped',
 'has_tail_pattern::multi-colored',
 'has_belly_pattern::solid',
 'has_belly_pattern::spotted',
 'has_belly_pattern::striped',
 'has_belly_pattern::multi-colored',
 'has_primary_color::blue',
 'has_primary_color::brown',
 'has_primary_color::iridescent',
 'has_primary_color::purple',
 'has_primary_color::rufous',
 'has_primary_color::grey',
 'has_primary_color::yellow',
 'has_primary_color::olive',
 'has_primary_color::green',
 'has_primary_color::pink',
 'has_primary_color::orange',
 'has_primary_color::black',
 'has_primary_color::white',
 'has_primary_color::red',
 'has_primary_color::buff',
 'has_leg_color::blue',
 'has_leg_color::brown',
 'has_leg_color::iridescent',
 'has_leg_color::purple',
 'has_leg_color::rufous',
 'has_leg_color::grey',
 'has_leg_color::yellow',
 'has_leg_color::olive',
 'has_leg_color::green',
 'has_leg_color::pink',
 'has_leg_color::orange',
 'has_leg_color::black',
 'has_leg_color::white',
 'has_leg_color::red',
 'has_leg_color::buff',
 'has_bill_color::blue',
 'has_bill_color::brown',
 'has_bill_color::iridescent',
 'has_bill_color::purple',
 'has_bill_color::rufous',
 'has_bill_color::grey',
 'has_bill_color::yellow',
 'has_bill_color::olive',
 'has_bill_color::green',
 'has_bill_color::pink',
 'has_bill_color::orange',
 'has_bill_color::black',
 'has_bill_color::white',
 'has_bill_color::red',
 'has_bill_color::buff',
 'has_crown_color::blue',
 'has_crown_color::brown',
 'has_crown_color::iridescent',
 'has_crown_color::purple',
 'has_crown_color::rufous',
 'has_crown_color::grey',
 'has_crown_color::yellow',
 'has_crown_color::olive',
 'has_crown_color::green',
 'has_crown_color::pink',
 'has_crown_color::orange',
 'has_crown_color::black',
 'has_crown_color::white',
 'has_crown_color::red',
 'has_crown_color::buff',
 'has_wing_pattern::solid',
 'has_wing_pattern::spotted',
 'has_wing_pattern::striped',
 'has_wing_pattern::multi-colored']

labels_keys = ['001.Black_footed_Albatross',
 '002.Laysan_Albatross',
 '003.Sooty_Albatross',
 '004.Groove_billed_Ani',
 '005.Crested_Auklet',
 '006.Least_Auklet',
 '007.Parakeet_Auklet',
 '008.Rhinoceros_Auklet',
 '009.Brewer_Blackbird',
 '010.Red_winged_Blackbird',
 '011.Rusty_Blackbird',
 '012.Yellow_headed_Blackbird',
 '013.Bobolink',
 '014.Indigo_Bunting',
 '015.Lazuli_Bunting',
 '016.Painted_Bunting',
 '017.Cardinal',
 '018.Spotted_Catbird',
 '019.Gray_Catbird',
 '020.Yellow_breasted_Chat',
 '021.Eastern_Towhee',
 '022.Chuck_will_Widow',
 '023.Brandt_Cormorant',
 '024.Red_faced_Cormorant',
 '025.Pelagic_Cormorant',
 '026.Bronzed_Cowbird',
 '027.Shiny_Cowbird',
 '028.Brown_Creeper',
 '029.American_Crow',
 '030.Fish_Crow',
 '031.Black_billed_Cuckoo',
 '032.Mangrove_Cuckoo',
 '033.Yellow_billed_Cuckoo',
 '034.Gray_crowned_Rosy_Finch',
 '035.Purple_Finch',
 '036.Northern_Flicker',
 '037.Acadian_Flycatcher',
 '038.Great_Crested_Flycatcher',
 '039.Least_Flycatcher',
 '040.Olive_sided_Flycatcher',
 '041.Scissor_tailed_Flycatcher',
 '042.Vermilion_Flycatcher',
 '043.Yellow_bellied_Flycatcher',
 '044.Frigatebird',
 '045.Northern_Fulmar',
 '046.Gadwall',
 '047.American_Goldfinch',
 '048.European_Goldfinch',
 '049.Boat_tailed_Grackle',
 '050.Eared_Grebe',
 '051.Horned_Grebe',
 '052.Pied_billed_Grebe',
 '053.Western_Grebe',
 '054.Blue_Grosbeak',
 '055.Evening_Grosbeak',
 '056.Pine_Grosbeak',
 '057.Rose_breasted_Grosbeak',
 '058.Pigeon_Guillemot',
 '059.California_Gull',
 '060.Glaucous_winged_Gull',
 '061.Heermann_Gull',
 '062.Herring_Gull',
 '063.Ivory_Gull',
 '064.Ring_billed_Gull',
 '065.Slaty_backed_Gull',
 '066.Western_Gull',
 '067.Anna_Hummingbird',
 '068.Ruby_throated_Hummingbird',
 '069.Rufous_Hummingbird',
 '070.Green_Violetear',
 '071.Long_tailed_Jaeger',
 '072.Pomarine_Jaeger',
 '073.Blue_Jay',
 '074.Florida_Jay',
 '075.Green_Jay',
 '076.Dark_eyed_Junco',
 '077.Tropical_Kingbird',
 '078.Gray_Kingbird',
 '079.Belted_Kingfisher',
 '080.Green_Kingfisher',
 '081.Pied_Kingfisher',
 '082.Ringed_Kingfisher',
 '083.White_breasted_Kingfisher',
 '084.Red_legged_Kittiwake',
 '085.Horned_Lark',
 '086.Pacific_Loon',
 '087.Mallard',
 '088.Western_Meadowlark',
 '089.Hooded_Merganser',
 '090.Red_breasted_Merganser',
 '091.Mockingbird',
 '092.Nighthawk',
 '093.Clark_Nutcracker',
 '094.White_breasted_Nuthatch',
 '095.Baltimore_Oriole',
 '096.Hooded_Oriole',
 '097.Orchard_Oriole',
 '098.Scott_Oriole',
 '099.Ovenbird',
 '100.Brown_Pelican',
 '101.White_Pelican',
 '102.Western_Wood_Pewee',
 '103.Sayornis',
 '104.American_Pipit',
 '105.Whip_poor_Will',
 '106.Horned_Puffin',
 '107.Common_Raven',
 '108.White_necked_Raven',
 '109.American_Redstart',
 '110.Geococcyx',
 '111.Loggerhead_Shrike',
 '112.Great_Grey_Shrike',
 '113.Baird_Sparrow',
 '114.Black_throated_Sparrow',
 '115.Brewer_Sparrow',
 '116.Chipping_Sparrow',
 '117.Clay_colored_Sparrow',
 '118.House_Sparrow',
 '119.Field_Sparrow',
 '120.Fox_Sparrow',
 '121.Grasshopper_Sparrow',
 '122.Harris_Sparrow',
 '123.Henslow_Sparrow',
 '124.Le_Conte_Sparrow',
 '125.Lincoln_Sparrow',
 '126.Nelson_Sharp_tailed_Sparrow',
 '127.Savannah_Sparrow',
 '128.Seaside_Sparrow',
 '129.Song_Sparrow',
 '130.Tree_Sparrow',
 '131.Vesper_Sparrow',
 '132.White_crowned_Sparrow',
 '133.White_throated_Sparrow',
 '134.Cape_Glossy_Starling',
 '135.Bank_Swallow',
 '136.Barn_Swallow',
 '137.Cliff_Swallow',
 '138.Tree_Swallow',
 '139.Scarlet_Tanager',
 '140.Summer_Tanager',
 '141.Artic_Tern',
 '142.Black_Tern',
 '143.Caspian_Tern',
 '144.Common_Tern',
 '145.Elegant_Tern',
 '146.Forsters_Tern',
 '147.Least_Tern',
 '148.Green_tailed_Towhee',
 '149.Brown_Thrasher',
 '150.Sage_Thrasher',
 '151.Black_capped_Vireo',
 '152.Blue_headed_Vireo',
 '153.Philadelphia_Vireo',
 '154.Red_eyed_Vireo',
 '155.Warbling_Vireo',
 '156.White_eyed_Vireo',
 '157.Yellow_throated_Vireo',
 '158.Bay_breasted_Warbler',
 '159.Black_and_white_Warbler',
 '160.Black_throated_Blue_Warbler',
 '161.Blue_winged_Warbler',
 '162.Canada_Warbler',
 '163.Cape_May_Warbler',
 '164.Cerulean_Warbler',
 '165.Chestnut_sided_Warbler',
 '166.Golden_winged_Warbler',
 '167.Hooded_Warbler',
 '168.Kentucky_Warbler',
 '169.Magnolia_Warbler',
 '170.Mourning_Warbler',
 '171.Myrtle_Warbler',
 '172.Nashville_Warbler',
 '173.Orange_crowned_Warbler',
 '174.Palm_Warbler',
 '175.Pine_Warbler',
 '176.Prairie_Warbler',
 '177.Prothonotary_Warbler',
 '178.Swainson_Warbler',
 '179.Tennessee_Warbler',
 '180.Wilson_Warbler',
 '181.Worm_eating_Warbler',
 '182.Yellow_Warbler',
 '183.Northern_Waterthrush',
 '184.Louisiana_Waterthrush',
 '185.Bohemian_Waxwing',
 '186.Cedar_Waxwing',
 '187.American_Three_toed_Woodpecker',
 '188.Pileated_Woodpecker',
 '189.Red_bellied_Woodpecker',
 '190.Red_cockaded_Woodpecker',
 '191.Red_headed_Woodpecker',
 '192.Downy_Woodpecker',
 '193.Bewick_Wren',
 '194.Cactus_Wren',
 '195.Carolina_Wren',
 '196.House_Wren',
 '197.Marsh_Wren',
 '198.Rock_Wren',
 '199.Winter_Wren',
 '200.Common_Yellowthroat']

def predict_concept(img_path):
    img = Image.open(img_path).convert('RGB')
    transform = transforms.Compose([
        transforms.Resize((224,224)),
        transforms.CenterCrop((224,224)),
        transforms.ToTensor(),
        transforms.Normalize([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])
    ])
    img = transform(img)
    img = torch.unsqueeze(img, dim=0)
    print(img.shape)
    concepts_values = nn.Sigmoid()(con_model(img)).squeeze().tolist()
    concept_dict = dict(zip(list(range(len(concepts_values))), concepts_values))
    concept_dict = {k: v for k, v in sorted(concept_dict.items(), key=lambda item: item[1], reverse=True)}

    concept_dist = []
    for i, (id, prob) in enumerate(concept_dict.items()):
        concept_dist.append({"concept": concepts_keys[id], "probability": prob, 'id': i, 'original_id': id})
    return concepts_values, concept_dist

def predict_label(concept_values):
    print(type(concept_values), type(concept_values[0]))
    concept_values = torch.tensor(concept_values, dtype=torch.float32)
    labels_values = nn.Softmax()(classifier_model(concept_values)).squeeze().tolist()

    labels_dict = dict(zip(labels_keys, labels_values))
    labels_dict = {k: v for k, v in sorted(labels_dict.items(), key=lambda item: item[1], reverse=True)}

    labels_dist = []
    for label, prob in labels_dict.items():
        labels_dist.append({"label": label, "probability": prob})
    return labels_dist
